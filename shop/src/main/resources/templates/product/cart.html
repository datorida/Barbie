<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/common :: head">
	<title>장바구니</title>
</head>

<body>
	<header th:replace="fragments/common :: copy"></header>
	<section>
		<div class="container">
			<h2>장바구니</h2>

			<!-- 로그인 상태인 경우에만 보이는 내용 -->
			<div th:if="${session != null}">
				<p th:text="'안녕하세요, ' + ${username} + '님!'"></p>
				<!-- 회원의 장바구니 상품 목록 표시 -->
				<table>
					<tr>
						<th>상품명</th>
						<th>수량</th>
						<th>상품가격</th>
						<th>총 가격</th>
					</tr>
					<tr th:each="cartItem : ${cartlist}">
						<td>
							<span th:if="${cartItem.product != null}" th:text="${cartItem.product.product_name}"></span>
							<span th:if="${cartItem.product == null}">상품 없음</span><!-- 상품이 null인 경우 기본값 설정 -->
						</td>
						<td>
							<span th:if="${cartItem.product != null}" th:text="${cartItem.product.counts}"></span>
							<span th:if="${cartItem.product == null}">0</span><!-- 상품이 null인 경우 0으로 설정 -->
						</td>
						<td>
							<span th:if="${cartItem.product != null}" th:text="${cartItem.product.price}"></span>
							<span th:if="${cartItem.product == null}">0</span><!-- 상품이 null인 경우 0으로 설정 -->
						</td>
						<td th:text="${cartItem.product != null ? cartItem.product.price * cartItem.counts : 0}"></td>
					</tr>
				</table>
			</div>
			<!--cartItem.product가 null인 경우에 대비하여 기본값을 설정하게 됩니다. 코드를 적용한 후 다시 테스트하여 정상적으로 동작하는지 확인하십시오.-->






			<!-- 로그인 상태가 아닌 경우에 보이는 내용 -->
			<div th:unless="${session != null}">

				<!-- 쿠키에서 읽어온 장바구니 정보 표시 -->
				<table id="cartTable">
					<tr>
						<th>상품 이름</th>
						<th>상품 수량</th>
						<th>상품 가격</th>
						<th>총 가격</th>
					</tr>
				</table>
			</div>
		</div>
	</section>

	<script src="js/jquery-3.4.1.min.js"></script>
	<script>
		//비로그인 상타에서 자압구니 정보를 표시하는 함수
		function displayCartFromCookie() {
			const existingCartCookie = getCookie("cart");
			if (existingCartCookie) {
				const cartItems = JSON.parse(existingCartCookie);

				//장바구니 테이블 또는 다른 html 요소를 선택하여 쿠키에서 가져온 정보를 표시합니다.-->
				const cartTable = document.getElementById("cartTable");

				//장바구니 테이블 초기화
				cartTable.innerHTML = "";

				//각 항목을 테이블에 추가
				for (const cartItem of cartItems) {
					const row = cartTable.insertRow();
					const cell1 = row.insertCell(0);
					const cell2 = row.insertCell(1);
					const cell3 = row.insertCell(2);
					const cell4 = row.insertCell(3);


					cell1.textContent = `상품 이름 : ${cartItem.product.product_name}`;
					cell2.textContent = `상품 수량 : ${cartItem.counts}`;
					cell3.textContent = `상품 가격 : ${cartItem.product.price}`;
					cell4.textContent = `총 가격 : ${cartItem.product.price * cartItem.counts}`;

				}
			}
		}
		//페이지 로드시 장바구니 정보를 표시
		window.onload = function () {
			displayCartFromCookie();
		}


		//getCookie 함수정의
		function getCookie(cookieName) {
			var name = cookieName + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var cookieArray = decodedCookie.split(';');

			for (var i = 0; i < cookieArray.length; i++) {
				var cookie = cookieArray[i].trim();
				if (cookie.indexOf(name) === 0) {
					return cookie.substring(name.length, cookie.length);
				}
			}
			return "";
		}

	</script>
	<footer th:replace="fragments/common :: footer-script"></footer>

</body>

</html>