<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/common :: head('ìƒí’ˆë¦¬ìŠ¤íŠ¸')">
<meta charset="utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<script th:src="@{/js/jquery-3.4.1.min.js}"></script>


</head>

<body>

	<header th:replace="fragments/common :: copy"></header>
	<div class="centered-container">
		<div id="product-container" class="product"
			data-product-num="${product.product_num}">
			<div class="product-img-container">
				<img th:src="'/' + ${product.image_url}" alt="Product Image"
					class="product-img">
			</div>
			<div class="product-detail">
				<h1 th:text="${product.product_name}" class="product-name">ì œí’ˆëª…</h1>
				<p th:text="${product.price} + '$'" class="price">ê°€ê²©</p>
				<p th:text="${product.product_info}" class="product-info"></p>
				<p class="count">
					<span th:if="${product.quantity > 0}"
						th:text="'Available Quantity:' + ${product.quantity}"></span> <span
						th:if="${product.quantity ==0}" class="sold-out">Sold Out</span>
				</p>

				<!-- ìƒí’ˆìˆ˜ëŸ‰ ì¶”ê°€ì‹œ í† íƒˆê¸ˆì•¡ -->
				<div class="input-container">
					<input type="number" id="quantity" min="1" value="1"
						th:disabled="${product.quantity==0}" class="quantity-input">
					<input type="hidden" id="available-quantity"
						th:value="${product.quantity}">
					<p id="total-amount" class="total-amount">
						Total Amount: <span id="calculated-total"></span> $
					</p>
				</div>

				<!-- ë²„íŠ¼ -->
				<div class="button-container">
					<div class="w-btn-outline w-btn-yellow-outline"
						id="add-to-cart-btn" type="button">Add to Cart</div>
					<div class="w-btn-outline w-btn-skin-outline buy-now-btn" type="button">Buy Now</div>
				</div>
			</div>

		</div>
	</div>

	<script>
		/*input type ìˆ˜ëŸ‰ ì œí•œ ì½”ë“œ*/
		var availableQuantity = parseInt(document
				.getElementById("available-quantity").value);

		var quantityInput = document.getElementById("quantity");
		quantityInput.addEventListener("change", function() {
			if (quantityInput.value > availableQuantity) {
				quantityInput.value = availableQuantity;
			}
		});

		/*ì´ ê¸ˆì•¡ ê³„ì‚°ê¸°*/
		function updateTotalAmount() {
			const quantityInput = document.getElementById('quantity');
			const calculatedTotalSpan = document
					.getElementById('calculated-total');
			const priceText = document.querySelector('.price').textContent; // ê°€ê²© í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
			const price = parseFloat(priceText.split(' ')[0]); // ê°€ê²© ê°’ì„ ì¶”ì¶œí•˜ê³  íŒŒì‹±í•˜ê¸°

			const quantity = parseInt(quantityInput.value);

			if (!isNaN(price) && !isNaN(quantity)) {
				const total = (price * quantity).toFixed(2);
				calculatedTotalSpan.textContent = total;
			}
		}

		
		
		/*ì¥ë°”êµ¬ë‹ˆ*/
	// ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¶€ì°©í•©ë‹ˆë‹¤
document.addEventListener("DOMContentLoaded", function () {
        updateTotalAmount();

        const quantityInput = document.getElementById('quantity');
        quantityInput.addEventListener('input', updateTotalAmount);

        const addToCartButton = document.getElementById("add-to-cart-btn");
        addToCartButton.addEventListener("click", function () {
            handleCartButtonClick();
        });

        const buyNowButton = document.querySelector(".buy-now-btn");
        buyNowButton.addEventListener("click", function () {
            handleBuyNowClick();
        });
    });
		
function handleCartButtonClick() {
    const quantityInput = document.getElementById('quantity');
    const quantity = parseInt(quantityInput.value);
    const productNum = dataProductNum;
    
    isLoggedIn(function (isLoggedIn) {
        if (!isLoggedIn) {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œì˜ ì²˜ë¦¬
            const existingCartCookie = getCookie("cart");
            if (existingCartCookie) {
                const cartItems = JSON.parse(existingCartCookie);
                const existingCartItem = cartItems.find(item => item.productNum === productNum);
                
                if (existingCartItem) {
                    existingCartItem.quantity += quantity;
                } else {
                    cartItems.push({ productNum, quantity });
                }
                
                setCookie("cart", JSON.stringify(cartItems), 7); // Set cookie for 7 days
            } else {
                setCookie("cart", JSON.stringify([{ productNum, quantity }]), 7);
            }
   
            alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¹„ë¡œê·¸ì¸ ìƒíƒœ)");
        }else{
        	//ë¡œê·¸ì¸ ìƒíƒœì¼ë•Œì˜ ì²˜ë¦¬
        addToCart(productNum, quantity);
        }
        });
}

    function handleBuyNowClick() {
        isLoggedIn(function (isLoggedIn) {
            if (!isLoggedIn) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!ğŸ˜˜");
                window.location.href = "[[@{/login}]]";
                return;
            }
            // Buy Now ë²„íŠ¼ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ë¡œì§ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
        });
    }

    function addToCart(productNum, quantity) {
        $.ajax({
        	url:'[[@{/addToCart}]]',
        	method:'POST',
        	data:{
        			productNum : productNum,
        			quantity : quantity
        			},
        	success : function(resopnse){
        		if(response==="true"){
        			alert ("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
        		}else if(response ==="out_of_stock"){
        			alert("ì¬ê³ ê°€ ë¶€ì¡±í•˜ì—¬ ì¶”ê°€ê°€ ë¶ˆê°€ëŠ¥ í•©ë‹ˆë‹¤.")
        			}
        		},
        		 error: function () {
        	            alert("ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        		 }
        		 })
    }

    function isLoggedIn(callback) {
        $.ajax({
            url: '[[@{/checkLogin}]]',
            method: 'GET',
            success: function (response) {
                callback(response === "true");
            },
            error: function () {
                callback(false);
            }
        });
    }



	</script>

	<!-- popper js -->
	<script
		src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
		crossorigin="anonymous">
	</script>
	<!-- bootstrap js -->
	<script src="/js/bootstrap.js"></script>
	<!-- owl slider -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js">
	</script>
	<!-- isotope js -->
	<script
		src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
	<!-- nice select -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
	<!-- custom js -->
	<script src="/js/custom.js"></script>
	<!-- Google Map -->
	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap">
	</script>
	<link rel="stylesheet" th:href="@{/css/product.css}">

</body>
</html>

