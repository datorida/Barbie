<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/common :: head">
<title>ìƒí’ˆë¦¬ìŠ¤íŠ¸</title>
</head>
<body>
	<header th:replace="fragments/common :: copy"></header>
	<section>
		<div class="centered-container">
			<div id="product-container" class="product"
				data-product-num="${product.product_num}">
				<div class="product-img-container">
					<img th:src="'/' + ${product.image_url}" alt="Product Image"
						class="product-img">
				</div>
				<div class="product-detail">
					<h1 th:text="${product.product_name}" class="product-name">ì œí’ˆëª…</h1>
					<p th:text="${product.price} + '$'" class="price">ê°€ê²©</p>
					<p th:text="${product.product_info}" class="product-info"></p>
					<p class="count">
						<span th:if="${product.quantity > 0}"
							th:text="'Available Quantity:' + ${product.quantity}"></span> <span
							th:if="${product.quantity == 0}" class="sold-out">Sold Out</span>
					</p>
					<!-- ìƒí’ˆìˆ˜ëŸ‰ ì¶”ê°€ì‹œ í† íƒˆê¸ˆì•¡ -->
					<div class="input-container">
						<input type="number" id="quantity" min="1" value="1"
							th:disabled="${product.quantity==0}" class="quantity-input">
						<input type="hidden" id="available-quantity"
							th:value="${product.quantity}">
						<p id="total-amount" class="total-amount">
							Total Amount: <span id="calculated-total"></span> $
						</p>
					</div>
					<!-- ë²„íŠ¼ -->
					<div class="button-container">
						<div class="w-btn-outline w-btn-yellow-outline"
							id="add-to-cart-btn" type="button">Add to Cart</div>
						<div class="w-btn-outline w-btn-skin-outline buy-now-btn"
							type="button">Buy Now</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
	// ì„ì‹œ ì‹ë³„ì ìƒì„± í•¨ìˆ˜
	function generateTemporaryIdentifierWithExpiration() {
	    const currentTime = new Date().getTime();
	    const expirationTime = currentTime + 60 * 60 * 1000; // 1ì‹œê°„ í›„ì˜ íƒ€ì„ìŠ¤íƒ¬í”„
	    const temporaryIdentifier = `guest_${currentTime}_${expirationTime}`;
	    return temporaryIdentifier;
	}

	// ì„ì‹œ ì‹ë³„ì ë§Œë£Œ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
	function isTemporaryIdentifierExpired(temporaryIdentifier) {
	    const expirationTime = temporaryIdentifier.split('_')[2];
	    const currentTime = new Date().getTime();
	    return currentTime > parseInt(expirationTime);
	}

	// ì¿ í‚¤ì—ì„œ ì„ì‹œ ì‹ë³„ì ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	function getTemporaryIdentifierFromCookie() {
	    const cookies = document.cookie.split('; ');
	    let temporaryIdentifier;
	    for (const cookie of cookies) {
	        const [name, value] = cookie.split('=');
	        if (name === 'temporaryIdentifier') {
	            temporaryIdentifier = value;
	            break;
	        }
	    }
	    return temporaryIdentifier;
	}

	// ì¿ í‚¤ì— ì„ì‹œ ì‹ë³„ì ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
	function setTemporaryIdentifierCookie(temporaryIdentifier) {
	    document.cookie = `temporaryIdentifier=${temporaryIdentifier}; path=/; max-age=${60 * 60}`;
	}

	// í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
	function initializePage() {
	    let temporaryIdentifier = getTemporaryIdentifierFromCookie();

	    if (!temporaryIdentifier || isTemporaryIdentifierExpired(temporaryIdentifier)) {
	        temporaryIdentifier = generateTemporaryIdentifierWithExpiration();
	        setTemporaryIdentifierCookie(temporaryIdentifier);
	    }

	    // ì„ì‹œ ì‹ë³„ìë¥¼ ì„œë²„ë¡œ ì „ì†¡
	    $.ajax({
	        url: '[[@{/storeTemporaryIdentifier}]]', // ì„ì‹œ ì‹ë³„ìë¥¼ ì„œë²„ì— ì „ì†¡í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸
	        method: 'POST',
	        data: {
	            temporaryIdentifier: temporaryIdentifier
	        },
	        success: function(response) {
	            console.log('ì„ì‹œ ì‹ë³„ì ì„œë²„ ì „ì†¡ ì„±ê³µ:', response);
	        },
	        error: function() {
	            console.error('ì„ì‹œ ì‹ë³„ì ì„œë²„ ì „ì†¡ ì˜¤ë¥˜');
	        }
	    });

	    // ë‚˜ë¨¸ì§€ í˜ì´ì§€ ì´ˆê¸°í™” ì½”ë“œ
	    updateTotalAmount();

	    const quantityInput = document.getElementById('quantity');
	    quantityInput.addEventListener('input', updateTotalAmount);

	    const addToCartButton = document.getElementById("add-to-cart-btn");
	    if (addToCartButton) {
	        addToCartButton.addEventListener("click", function() {
	            handleCartButtonClick();
	        });
	    } else {
	        console.error("Unable to find the 'Add to Cart' button element.");
	    }

	    const buyNowButton = document.querySelector(".buy-now-btn");
	    buyNowButton.addEventListener("click", function() {
	        handleBuyNowClick();
	    });
	}

	// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
	document.addEventListener("DOMContentLoaded", initializePage);

	// ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	function handleCartButtonClick() {
	    const urlParams = new URLSearchParams(window.location.search);
	    const dataProductNum = urlParams.get('productNum');
	    const quantityInput = document.getElementById('quantity');
	    const quantity = parseInt(quantityInput.value);
	    const productNum = dataProductNum;

	    let temporaryIdentifier = getTemporaryIdentifierFromCookie();

	    if (!temporaryIdentifier || isTemporaryIdentifierExpired(temporaryIdentifier)) {
	        temporaryIdentifier = generateTemporaryIdentifierWithExpiration();
	        setTemporaryIdentifierCookie(temporaryIdentifier);
	    }

	    isLoggedIn(function(isLoggedIn) {
	        if (!isLoggedIn) {
	            addToCartAsGuest(productNum, quantity, temporaryIdentifier);
	        } else {
	            addToCart(productNum, quantity);
	        }
	    });
	}
		// Function to add a product to the cart for logged-in users
		function addToCart(productNum, quantity) {
			$.ajax({
				url : '[[@{/addToCart}]]',
				method : 'POST',
				data : {
					productNum : productNum,
					quantity : quantity
				},
				success : function(response) {
					console.log("addToCart í•¨ìˆ˜ í˜¸ì¶œë¨.");
					console.log("productNum:", productNum);
					console.log("quantity:", quantity);

					if (response === "true") {
						alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
					} else if (response === "existingCart") {
						alert("í•´ë‹¹ ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
					} else if (response === "out_of_stock") {
						alert("ì¬ê³ ê°€ ë¶€ì¡±í•˜ì—¬ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
					} else if (response === "error") {
						alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
					} else {
						alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					}
				},
				error : function() {
					alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
				}
			});
		}

		// Function to add a product to the cart for guest users

		function addToCartAsGuest(productNum, quantity, temporaryIdentifier) {
			$.ajax({
				url : '[[@{/addToCartAsGuest}]]', // ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ URLë¡œ ëŒ€ì²´
				method : 'POST',
				data : {
					productNum : productNum,
					quantity : quantity,
					temporaryIdentifier : temporaryIdentifier
				},
				success : function(response) {
					console.log("addToCartAsGuest í•¨ìˆ˜ í˜¸ì¶œë¨.");
					console.log("productNum:", productNum);
					console.log("quantity:", quantity);
					console.log("temporaryIdentifier:", temporaryIdentifier);

					if (response === "true") {
						alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
					} else if (response === "existingCart") {
						alert("í•´ë‹¹ ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
					} else if (response === "out_of_stock") {
						alert("ì¬ê³ ê°€ ë¶€ì¡±í•˜ì—¬ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
					} else if (response === "error") {
						alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
					} else {
						alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					}
				},
				error : function() {
					alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
				}
			});
		}

		/* isLoggedIn(callback)  í•¨ìˆ˜ì •ì˜ */
		function isLoggedIn(callback) {
			$.ajax({
				url : '[[@{/checkLogin}]]',
				method : 'GET',
				success : function(response) {
					callback(response === "true");
				},
				error : function() {
					callback(false);
				}
			});
		}

		/*input type ìˆ˜ëŸ‰ ì œí•œ ì½”ë“œ*/
		var availableQuantity = parseInt(document
				.getElementById("available-quantity").value);

		var quantityInput = document.getElementById("quantity");
		quantityInput.addEventListener("change", function() {
			if (quantityInput.value > availableQuantity) {
				alert("êµ¬ë§¤ ê°€ëŠ¥í•œ ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.");
				quantityInput.value = availableQuantity;
			}
		});

		/*ì´ ê¸ˆì•¡ ê³„ì‚°ê¸°*/
		function updateTotalAmount() {
			const quantityInput = document.getElementById('quantity');
			const calculatedTotalSpan = document
					.getElementById('calculated-total');
			const priceText = document.querySelector('.price').textContent; // ê°€ê²© í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
			const price = parseFloat(priceText.split(' ')[0]); // ê°€ê²© ê°’ì„ ì¶”ì¶œí•˜ê³  íŒŒì‹±í•˜ê¸°

			const quantity = parseInt(quantityInput.value);

			if (!isNaN(price) && !isNaN(quantity)) {
				const total = (price * quantity).toFixed(2);
				calculatedTotalSpan.textContent = total;
			}
		}

		//handleBuyNowClick()  í•¨ìˆ˜ì •ì˜ êµ¬ë§¤ë²„íŠ¼
		function handleBuyNowClick() {
			isLoggedIn(function(isLoggedIn) {
				if (!isLoggedIn) {
					alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!ğŸ˜˜");
					window.location.href = "[[@{/login}]]";
					return;
				}
				// Buy Now ë²„íŠ¼ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ë¡œì§ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
			});
		}
	</script>

	<footer th:replace="fragments/common :: footer-script"></footer>
</body>
</html>