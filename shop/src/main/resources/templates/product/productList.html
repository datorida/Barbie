<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/common :: head">
<title>ìƒí’ˆë¦¬ìŠ¤íŠ¸</title>
</head>

<body>

	<header th:replace="fragments/common :: copy"></header>
	<section>
		<div class="centered-container">
			<div id="product-container" class="product"
				data-product-num="${product.product_num}">
				<div class="product-img-container">
					<img th:src="'/' + ${product.image_url}" alt="Product Image"
						class="product-img">
				</div>
				<div class="product-detail">
					<h1 th:text="${product.product_name}" class="product-name">ì œí’ˆëª…</h1>
					<p th:text="${product.price} + '$'" class="price">ê°€ê²©</p>
					<p th:text="${product.product_info}" class="product-info"></p>
					<p class="count">
						<span th:if="${product.quantity > 0}"
							th:text="'Available Quantity:' + ${product.quantity}"></span> <span
							th:if="${product.quantity ==0}" class="sold-out">Sold Out</span>
					</p>

					<!-- ìƒí’ˆìˆ˜ëŸ‰ ì¶”ê°€ì‹œ í† íƒˆê¸ˆì•¡ -->
					<div class="input-container">
						<input type="number" id="quantity" min="1" value="1"
							th:disabled="${product.quantity==0}" class="quantity-input">
						<input type="hidden" id="available-quantity"
							th:value="${product.quantity}">
						<p id="total-amount" class="total-amount">
							Total Amount: <span id="calculated-total"></span> $
						</p>
					</div>

					<!-- ë²„íŠ¼ -->
					<div class="button-container">
						<div class="w-btn-outline w-btn-yellow-outline"
							id="add-to-cart-btn"  type="button">Add to Cart</div>
						<div class="w-btn-outline w-btn-skin-outline buy-now-btn"
							type="button">Buy Now</div>
					</div>
				</div>

			</div>
		</div>
	</section>


	<script>
	
	/*ì¥ë°”êµ¬ë‹ˆ*/
	// ìƒí’ˆ ì¶”ê°€ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¶€ì°©í•©ë‹ˆë‹¤
document.addEventListener("DOMContentLoaded", function () {
        updateTotalAmount();
		
        const quantityInput = document.getElementById('quantity');
        quantityInput.addEventListener('input', updateTotalAmount);

        const addToCartButton = document.getElementById("add-to-cart-btn");
        if (addToCartButton) {
            addToCartButton.addEventListener("click", function () {
                handleCartButtonClick();
            });
        } else {
            console.error("Unable to find the 'Add to Cart' button element.");
        }

        const buyNowButton = document.querySelector(".buy-now-btn");
        buyNowButton.addEventListener("click", function () {
            handleBuyNowClick();
        });
    });
		
function handleCartButtonClick() {
    const urlParams = new URLSearchParams(window.location.search);
    const dataProductNum = urlParams.get('productNum');
    const quantityInput = document.getElementById('quantity');
    const quantity = parseInt(quantityInput.value);
    const productNum = dataProductNum;

    isLoggedIn(function (isLoggedIn) {
        if (!isLoggedIn) {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œì˜ ì²˜ë¦¬
            const existingCartCookie = getCookie("cart");
            const cartItems = existingCartCookie ? JSON.parse(existingCartCookie) : [];
            
            const existingCartItemIndex = cartItems.findIndex(item => item.productNum === productNum);

            if (existingCartItemIndex !== -1) {
                // ì´ë¯¸ í•´ë‹¹ ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ìˆì„ ê²½ìš° ìˆ˜ëŸ‰ ì¦ê°€
                cartItems[existingCartItemIndex].quantity += quantity;
            } else {
                // ìƒˆë¡œìš´ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
                 cartItems.push({ product: { product_num: productNum }, counts: quantity });
            }

            setCookie("cart", JSON.stringify(cartItems), 7);
            updateCartItemCount(); // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ìˆ˜ ì—…ë°ì´íŠ¸

            alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¹„ë¡œê·¸ì¸ ìƒíƒœ)");
        } else {
            // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œì˜ ì²˜ë¦¬
            addToCart(productNum, quantity);
        }
    });
}


//getCookie í•¨ìˆ˜ì •ì˜
function getCookie(cookieName) {
    var name = cookieName + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var cookieArray = decodedCookie.split(';');
    
    for (var i = 0; i < cookieArray.length; i++) {
        var cookie = cookieArray[i].trim();
        if (cookie.indexOf(name) === 0) {
            return cookie.substring(name.length, cookie.length);
        }
    }
    return "";
}

//setCookie í•¨ìˆ˜ì •ì˜ 
function setCookie(cookieName, cookieValue, days) {
    var expirationDate = new Date();
    expirationDate.setDate(expirationDate.getDate() + days);
    var cookie = encodeURIComponent(cookieName) + "=" + encodeURIComponent(cookieValue) + "; expires=" + expirationDate.toUTCString() + "; path=/";
    document.cookie = cookie;
}


//handleBuyNowClick()  í•¨ìˆ˜ì •ì˜
    function handleBuyNowClick() {
        isLoggedIn(function (isLoggedIn) {
            if (!isLoggedIn) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!ğŸ˜˜");
                window.location.href = "[[@{/login}]]";
                return;
            }
            // Buy Now ë²„íŠ¼ì— ëŒ€í•œ ì¶”ê°€ì ì¸ ë¡œì§ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
        });
    }

//addToCart(productNum, quantity) í•¨ìˆ˜ì •ì˜
function addToCart(productNum, quantity) {
    $.ajax({
        url: '[[@{/addToCart}]]',
        method: 'POST',
        data: {
            productNum: productNum,
            quantity: quantity
        },
        success: function (response) {
        	
        	console.log("addToCart í•¨ìˆ˜ í˜¸ì¶œë¨.");
            console.log("productNum:", productNum);
            console.log("quantity:", quantity);

            if (response === "true") {
                alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");                
            }else if(response ==="existingCart"){
            	alert("í•´ë‹¹ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ì¡´ì¬ í•©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            } else if (response === "out_of_stock") {
                alert("ì¬ê³ ê°€ ë¶€ì¡±í•˜ì—¬ ì¶”ê°€ê°€ ë¶ˆê°€ëŠ¥ í•©ë‹ˆë‹¤.");
            } else if (response === "error") {
                alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        },
        error: function () {
            alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });
}

//í˜ì´ì§€ ë¡œë”© ì‹œì— ì¥ë°”êµ¬ë‹ˆ ê°¯ìˆ˜ ì—…ë°ì´íŠ¸
function updateCartItemCountOnLoad() {
    updateCartItemCount();
}

// ì´ë™ ì‹œì— ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
function updateCartItemCountOnNavigation() {
    updateCartItemCount();
}

document.addEventListener("DOMContentLoaded", updateCartItemCountOnLoad);

// ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ ë– ë‚  ë•Œë§Œ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡
if (window.location.pathname !== '/cart') {
    window.addEventListener('beforeunload', updateCartItemCountOnNavigation);
}


//ì¥ë°”êµ¬ë‹ˆ ê°¯ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateCartItemCount() {
    const cartItems = getCookie("cart");
    const cartItemCountElement = document.getElementById("cartItemCount");
    
    if (cartItems) {
        const itemCount = JSON.parse(cartItems).reduce((sum, item) => sum + item.quantity, 0);
        cartItemCountElement.textContent = itemCount;
    } else {
        cartItemCountElement.textContent = "0";
    }
}
/* isLoggedIn(callback)  í•¨ìˆ˜ì •ì˜ */
    function isLoggedIn(callback) {
        $.ajax({
            url: '[[@{/checkLogin}]]',
            method: 'GET',
            success: function (response) {
                callback(response === "true");
            },
            error: function () {
                callback(false);
            }
        });
    }
    
    
		/*input type ìˆ˜ëŸ‰ ì œí•œ ì½”ë“œ*/
	var availableQuantity = parseInt(document.getElementById("available-quantity").value);

var quantityInput = document.getElementById("quantity");
quantityInput.addEventListener("change", function() {
    if (quantityInput.value > availableQuantity) {
        alert("êµ¬ë§¤ ê°€ëŠ¥í•œ ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.");
        quantityInput.value = availableQuantity;
    }
});


		/*ì´ ê¸ˆì•¡ ê³„ì‚°ê¸°*/
		function updateTotalAmount() {
			const quantityInput = document.getElementById('quantity');
			const calculatedTotalSpan = document
					.getElementById('calculated-total');
			const priceText = document.querySelector('.price').textContent; // ê°€ê²© í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
			const price = parseFloat(priceText.split(' ')[0]); // ê°€ê²© ê°’ì„ ì¶”ì¶œí•˜ê³  íŒŒì‹±í•˜ê¸°

			const quantity = parseInt(quantityInput.value);

			if (!isNaN(price) && !isNaN(quantity)) {
				const total = (price * quantity).toFixed(2);
				calculatedTotalSpan.textContent = total;
			}
		}



	</script>

	<footer th:replace="fragments/common :: footer-script"></footer>
</body>
</html>

